<!DOCTYPE html>
<html>
<head>
    <title>Speech-to-Text Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .record { background: #4CAF50; color: white; }
        .stop { background: #f44336; color: white; }
        .test { background: #2196F3; color: white; }
        .recording { background: #ff9800; color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #result { background: white; padding: 15px; border-radius: 5px; margin-top: 10px; min-height: 50px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h1>üé§ AI Interviewer - Speech-to-Text Test</h1>
    
    <div class="container">
        <h3>Test Amazon Transcribe Service</h3>
        <button onclick="testService()" class="test">Test Service Status</button>
        <div id="serviceStatus"></div>
    </div>
    
    <div class="container">
        <h3>Record and Transcribe Audio</h3>
        <p>Click "Start Recording", speak clearly for a few seconds, then click "Stop Recording".</p>
        
        <button id="recordBtn" onclick="startRecording()" class="record">üé§ Start Recording</button>
        <button id="stopBtn" onclick="stopRecording()" class="stop" disabled>‚èπÔ∏è Stop Recording</button>
        
        <div id="recordingStatus"></div>
        <div id="result"></div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        const BACKEND_URL = 'http://localhost:8000';

        async function testService() {
            const statusDiv = document.getElementById('serviceStatus');
            statusDiv.innerHTML = '<div class="status info">Testing service...</div>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/test-transcribe`);
                const data = await response.json();
                
                if (data.available) {
                    statusDiv.innerHTML = `<div class="status success">‚úÖ ${data.message}</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="status error">‚ùå ${data.message}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Service test failed: ${error.message}</div>`;
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await transcribeAudio(audioBlob);
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                
                // Update UI
                document.getElementById('recordBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('recordingStatus').innerHTML = 
                    '<div class="status recording">üî¥ Recording... Speak now!</div>';
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                document.getElementById('recordingStatus').innerHTML = 
                    '<div class="status error">‚ùå Microphone access denied. Please allow microphone access.</div>';
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                
                // Update UI
                document.getElementById('recordBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('recordingStatus').innerHTML = 
                    '<div class="status info">‚è≥ Processing audio...</div>';
            }
        }

        async function transcribeAudio(audioBlob) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="status info">üîÑ Transcribing speech...</div>';
            
            try {
                const formData = new FormData();
                formData.append('file', audioBlob, 'recording.webm');
                formData.append('session_id', 'test-session-' + Date.now());
                
                const response = await fetch(`${BACKEND_URL}/transcribe-audio`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    let statusClass = 'success';
                    let icon = '‚úÖ';
                    
                    if (result.status !== 'success') {
                        statusClass = 'error';
                        icon = '‚ö†Ô∏è';
                    }
                    
                    resultDiv.innerHTML = `
                        <div class="status ${statusClass}">
                            ${icon} <strong>Status:</strong> ${result.status}<br>
                            <strong>Confidence:</strong> ${(result.confidence * 100).toFixed(1)}%
                        </div>
                        <div style="margin-top: 10px;">
                            <strong>Transcription:</strong><br>
                            <em>"${result.transcription}"</em>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="status error">‚ùå Transcription request failed</div>';
                }
                
            } catch (error) {
                console.error('Transcription error:', error);
                resultDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            } finally {
                document.getElementById('recordingStatus').innerHTML = '';
            }
        }

        // Test service on page load
        window.onload = () => {
            testService();
        };
    </script>
</body>
</html>